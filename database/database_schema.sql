DROP DATABASE IF EXISTS BKFOOD;
CREATE DATABASE BKFOOD;
USE BKFOOD;

-- ====================================================
-- PHẦN 1: TẠO BẢNG (SCHEMA) - KHỚP VỚI TYPESCRIPT
-- ====================================================

CREATE TABLE USERS (
    ID INT PRIMARY KEY AUTO_INCREMENT,
    FULL_NAME VARCHAR(255) NOT NULL,
    EMAIL VARCHAR(255) UNIQUE NOT NULL,
    PASSWORD VARCHAR(255) NOT NULL,
    ADDRESS VARCHAR(255),
    PHONE VARCHAR(20),
    ROLE ENUM('CUSTOMER', 'SHIPPER', 'RESTAURANT', 'ADMIN') NOT NULL,
    CREATED_AT DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE CUSTOMERS (
    USER_ID INT PRIMARY KEY,
    POINTS INT DEFAULT 0,
    FOREIGN KEY (USER_ID) REFERENCES USERS(ID) ON DELETE CASCADE
);

CREATE TABLE SHIPPERS (
    USER_ID INT PRIMARY KEY,
    VEHICLE_TYPE VARCHAR(50) NOT NULL,
    LICENSE_PLATE VARCHAR(20) NOT NULL,
    IS_BUSY BOOLEAN default FALSE,
    FOREIGN KEY (USER_ID) REFERENCES USERS(ID) ON DELETE CASCADE
);

CREATE TABLE RESTAURANTS (
    USER_ID INT PRIMARY KEY,
    DESCRIPTION TEXT,
    IMAGE VARCHAR(255),
    RATING DECIMAL(2, 1) DEFAULT 0.0,
    IS_OPEN BOOLEAN DEFAULT TRUE,
    -- Các trường mới từ Mock Data
    DELIVERY_TIME VARCHAR(50),
    DELIVERY_FEE DECIMAL(12,0),
    MIN_ORDER DECIMAL(12,0),
    FOREIGN KEY (USER_ID) REFERENCES USERS(ID) ON DELETE CASCADE
);

CREATE TABLE CATEGORIES (
    ID INT PRIMARY KEY AUTO_INCREMENT,
    RESTAURANT_ID INT NOT NULL, 
    NAME VARCHAR(100) NOT NULL,      
    FOREIGN KEY (RESTAURANT_ID) REFERENCES RESTAURANTS(USER_ID) ON DELETE CASCADE
);

CREATE TABLE DISHES (
    ID INT PRIMARY KEY AUTO_INCREMENT,
    RESTAURANT_ID INT NOT NULL, 
    CATEGORY_ID INT,                 
    NAME VARCHAR(255) NOT NULL,
    PRICE DECIMAL(12, 0) NOT NULL,   
    IMAGE VARCHAR(255),             
    DESCRIPTION TEXT,               
    IS_AVAILABLE BOOLEAN DEFAULT TRUE, 
    FOREIGN KEY (RESTAURANT_ID) REFERENCES RESTAURANTS(USER_ID) ON DELETE CASCADE,
    FOREIGN KEY (CATEGORY_ID) REFERENCES CATEGORIES(ID) ON DELETE SET NULL
);

CREATE TABLE ORDERS (
    ID INT PRIMARY KEY AUTO_INCREMENT,
    CUSTOMER_ID INT NOT NULL,
    RESTAURANT_ID INT NOT NULL,
    SHIPPER_ID INT,            
    TOTAL_PRICE DECIMAL(12, 0) NOT NULL,
    SHIPPING_ADDRESS VARCHAR(255) NOT NULL,
    CUSTOMER_PHONE VARCHAR(20),
    NOTE TEXT,
    STATUS ENUM('PENDING', 'CONFIRMED', 'PREPARING', 'SHIPPING', 'COMPLETED', 'CANCELLED', 'DELIVERING'),
    CREATED_AT DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (CUSTOMER_ID) REFERENCES CUSTOMERS(USER_ID) ON DELETE CASCADE,
    FOREIGN KEY (RESTAURANT_ID) REFERENCES RESTAURANTS(USER_ID) ON DELETE CASCADE,
    FOREIGN KEY (SHIPPER_ID) REFERENCES SHIPPERS(USER_ID) ON DELETE SET NULL
);

CREATE TABLE ORDER_DETAILS (
    ID INT PRIMARY KEY AUTO_INCREMENT,
    ORDER_ID INT NOT NULL,
    DISH_ID INT,
    QUANTITY INT NOT NULL DEFAULT 1,
    PRICE DECIMAL(12, 0) NOT NULL, 
    FOREIGN KEY (ORDER_ID) REFERENCES ORDERS(ID) ON DELETE CASCADE,
    FOREIGN KEY (DISH_ID) REFERENCES DISHES(ID) ON DELETE SET NULL
);

CREATE TABLE REVIEWS (
    ID INT PRIMARY KEY AUTO_INCREMENT,
    CUSTOMER_ID INT NOT NULL,
    RESTAURANT_ID INT NOT NULL,
    ORDER_ID INT NOT NULL, 
    RATING INT CHECK (RATING >= 1 AND RATING <= 5),
    COMMENT TEXT,
    CREATED_AT DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (CUSTOMER_ID) REFERENCES CUSTOMERS(USER_ID) ON DELETE CASCADE,
    FOREIGN KEY (RESTAURANT_ID) REFERENCES RESTAURANTS(USER_ID) ON DELETE CASCADE,
    FOREIGN KEY (ORDER_ID) REFERENCES ORDERS(ID) ON DELETE CASCADE
);

-- Bảng Assignment (Phân công giao hàng)
CREATE TABLE DELIVERY_ASSIGNMENTS (
    ID INT PRIMARY KEY AUTO_INCREMENT, 
    ORDER_ID INT NOT NULL,
    DRIVER_ID INT NOT NULL,
    PICKUP_ADDRESS VARCHAR(255),
    DROPOFF_ADDRESS VARCHAR(255),
    SCHEDULED_PICKUP DATETIME,
    SCHEDULED_DELIVERY DATETIME,
    DISTANCE_KM DECIMAL(5, 2),
    DURATION_MINUTES INT,
    STATUS VARCHAR(50),
    NOTES TEXT,
    FOREIGN KEY (ORDER_ID) REFERENCES ORDERS(ID) ON DELETE CASCADE,
    FOREIGN KEY (DRIVER_ID) REFERENCES SHIPPERS(USER_ID) ON DELETE CASCADE
);

-- Bảng Route (Lộ trình chi tiết)
CREATE TABLE DELIVERY_ROUTES (
    ID INT PRIMARY KEY AUTO_INCREMENT,
    ASSIGNMENT_ID VARCHAR(50) NOT NULL,
    INSTRUCTION TEXT,
    DISTANCE_KM DECIMAL(5, 2),
    DURATION_MINUTES INT,
    SEQUENCE_ORDER INT,
    FOREIGN KEY (ASSIGNMENT_ID) REFERENCES DELIVERY_ASSIGNMENTS(ID) ON DELETE CASCADE
);

-- ====================================================
-- PHẦN 2: NẠP DỮ LIỆU (MOCK DATA MAPPING)
-- ====================================================

-- 1. USERS
-- Tạo 6 user để phục vụ cho 1 khách, 4 quán, 1 shipper
INSERT INTO USERS (ID, FULL_NAME, EMAIL, PASSWORD, ADDRESS, PHONE, ROLE) VALUES 
(1, 'Nguyễn Văn A', 'student@bk.edu.vn', '123456', 'Ký túc xá khu A, ĐHBK', '0901234567', 'CUSTOMER'),
(2, 'Cơm Tấm Sài Gòn', 'comtam@restaurant.com', '123456', 'Quận 1, TP.HCM', '0903333333', 'RESTAURANT'),
(3, 'Phở Hà Nội', 'pho@restaurant.com', '123456', 'Hà Nội', '0904444444', 'RESTAURANT'),
(4, 'Bánh Mì 37', 'banhmi@restaurant.com', '123456', 'Quận 3, TP.HCM', '0905555555', 'RESTAURANT'),
(5, 'Trà Sữa Gongcha', 'gongcha@restaurant.com', '123456', 'Quận 10, TP.HCM', '0906666666', 'RESTAURANT'),
(6, 'Huỳnh Huy Hoàng', 'shipper@vnexpress.vn', '123456', 'Bến xe Miền Đông', '0843301338', 'SHIPPER'); 

-- 2. ROLE DETAILS
INSERT INTO CUSTOMERS (USER_ID, POINTS) VALUES (1, 100);

INSERT INTO SHIPPERS (USER_ID, VEHICLE_TYPE, LICENSE_PLATE, IS_BUSY) 
VALUES (6, 'Xe máy Honda Vision', '59-T1 12345', FALSE);

-- Insert 4 nhà hàng (Khớp mockRestaurants)
INSERT INTO RESTAURANTS (USER_ID, DESCRIPTION, IMAGE, RATING, IS_OPEN, DELIVERY_TIME, DELIVERY_FEE, MIN_ORDER) VALUES 
(2, 'Cơm tấm ngon, giá sinh viên', '/vietnamese-broken-rice-restaurant.jpg', 4.5, TRUE, '15-20 phút', 5000, 20000),
(3, 'Phở bò, phở gà chính gốc', '/vietnamese-pho.png', 4.7, TRUE, '20-25 phút', 8000, 25000),
(4, 'Bánh mì thịt, trứng, pate', '/vietnamese-banh-mi-sandwich.jpg', 4.3, TRUE, '10-15 phút', 3000, 15000),
(5, 'Trà sữa, trà trái cây tươi mát', '/bubble-tea-milk-tea-shop.jpg', 4.6, TRUE, '15-20 phút', 5000, 20000);

-- 3. CATEGORIES & DISHES (Khớp mockMenuItems)
INSERT INTO CATEGORIES (ID, RESTAURANT_ID, NAME) VALUES 
(1, 2, 'Cơm'), (2, 3, 'Phở'), (3, 4, 'Bánh Mì'), (4, 5, 'Đồ Uống');

INSERT INTO DISHES (ID, RESTAURANT_ID, CATEGORY_ID, NAME, DESCRIPTION, PRICE, IMAGE, IS_AVAILABLE) VALUES 
-- Cơm Tấm (ID 1, 2)
(1, 2, 1, 'Cơm Tấm Sườn Bì', 'Sườn nướng, bì, chả trứng', 35000, '/com-tam-suon-bi-vietnamese.jpg', TRUE),
(2, 2, 1, 'Cơm Tấm Sườn Trứng', 'Sườn nướng, trứng ốp la', 30000, '/com-tam-suon-trung-vietnamese.jpg', TRUE),
-- Phở (ID 3, 4)
(3, 3, 2, 'Phở Bò Tái', 'Phở bò tái, nước dùng đậm đà', 40000, '/pho-bo-tai-beef-noodle-soup.jpg', TRUE),
(4, 3, 2, 'Phở Gà', 'Phở gà thơm ngon, thanh đạm', 35000, '/pho-ga-chicken-noodle-soup.jpg', TRUE),
-- Bánh Mì (ID 5, 6)
(5, 4, 3, 'Bánh Mì Thịt', 'Thịt nguội, pate, rau thơm', 20000, '/banh-mi-thit-vietnamese-sandwich.jpg', TRUE),
(6, 4, 3, 'Bánh Mì Trứng', 'Trứng ốp la, pate, rau', 18000, '/banh-mi-trung-egg-sandwich.jpg', TRUE),
-- Gongcha (ID 7, 8)
(7, 5, 4, 'Trà Sữa Trân Châu', 'Trà sữa trân châu đường đen', 25000, '/bubble-tea-brown-sugar.jpg', TRUE),
(8, 5, 4, 'Trà Đào Cam Sả', 'Trà trái cây tươi mát', 28000, '/peach-tea-fruit-tea.jpg', TRUE);

-- 4. ORDERS (Khớp mockOrders)
-- o1: Completed. Không có assignment.
INSERT INTO ORDERS (ID, CUSTOMER_ID, RESTAURANT_ID, SHIPPER_ID, TOTAL_PRICE, SHIPPING_ADDRESS, CUSTOMER_PHONE, STATUS, CREATED_AT) 
VALUES (1, 1, 2, NULL, 75000, 'Ký túc xá khu A, ĐHBK', '0901234567', 'COMPLETED', '2025-01-05 00:00:00');

-- o2: Confirmed. Có shipper ID 6 (u3).
INSERT INTO ORDERS (ID, CUSTOMER_ID, RESTAURANT_ID, SHIPPER_ID, TOTAL_PRICE, SHIPPING_ADDRESS, CUSTOMER_PHONE, NOTE, STATUS, CREATED_AT) 
VALUES (2, 1, 3, 6, 75000, 'Ký túc xá khu B, ĐHBK', '0901234567', 'Giao trước giờ học lúc 12h', 'CONFIRMED', '2025-01-12 11:30:00');

-- o3: Delivering. Có shipper ID 6.
INSERT INTO ORDERS (ID, CUSTOMER_ID, RESTAURANT_ID, SHIPPER_ID, TOTAL_PRICE, SHIPPING_ADDRESS, CUSTOMER_PHONE, STATUS, CREATED_AT) 
VALUES (3, 1, 4, 6, 60000, 'Thư viện Tạ Quang Bửu', '0901234567', 'DELIVERING', '2025-01-12 08:15:00');

-- o4: Completed. Có shipper ID 6.
INSERT INTO ORDERS (ID, CUSTOMER_ID, RESTAURANT_ID, SHIPPER_ID, TOTAL_PRICE, SHIPPING_ADDRESS, CUSTOMER_PHONE, STATUS, CREATED_AT) 
VALUES (4, 1, 5, 6, 56000, 'Ký túc xá khu A, ĐHBK', '0901234567', 'COMPLETED', '2024-12-28 15:45:00');

-- 5. ORDER DETAILS
INSERT INTO ORDER_DETAILS (ORDER_ID, DISH_ID, QUANTITY, PRICE) VALUES 
(1, 1, 2, 35000),           -- Order 1: 2 Cơm tấm
(2, 3, 1, 40000), (2, 4, 1, 35000), -- Order 2: 1 Phở Tái, 1 Phở Gà
(3, 5, 3, 20000),           -- Order 3: 3 Bánh Mì
(4, 8, 2, 28000);           -- Order 4: 2 Trà Đào

-- 6. REVIEWS (Khớp mockReviews)
INSERT INTO REVIEWS (ID, ORDER_ID, CUSTOMER_ID, RESTAURANT_ID, RATING, COMMENT, CREATED_AT) 
VALUES (1, 1, 1, 2, 5, 'Ngon, giao nhanh, giá sinh viên!', '2025-01-05 00:00:00');

-- 7. DELIVERY ASSIGNMENTS (Khớp mockDeliveryAssignments)
-- d1 cho Order o2
INSERT INTO DELIVERY_ASSIGNMENTS (ID, ORDER_ID, DRIVER_ID, PICKUP_ADDRESS, DROPOFF_ADDRESS, SCHEDULED_PICKUP, SCHEDULED_DELIVERY, DISTANCE_KM, DURATION_MINUTES, STATUS, NOTES)
VALUES ('d1', 2, 6, 'Phở Hà Nội - 123 Lý Thường Kiệt, Q.10', 'Ký túc xá khu B, ĐHBK', '2025-01-12 11:45:00', '2025-01-12 12:10:00', 3.4, 18, 'assigned', 'Gọi khách khi tới cổng ký túc xá.');

-- d2 cho Order o3
INSERT INTO DELIVERY_ASSIGNMENTS (ID, ORDER_ID, DRIVER_ID, PICKUP_ADDRESS, DROPOFF_ADDRESS, SCHEDULED_PICKUP, SCHEDULED_DELIVERY, DISTANCE_KM, DURATION_MINUTES, STATUS)
VALUES ('d2', 3, 6, 'Bánh Mì 37 - 89 Nguyễn Thị Minh Khai', 'Thư viện Tạ Quang Bửu', '2025-01-12 08:05:00', '2025-01-12 08:30:00', 2.6, 14, 'in_transit');

-- d3 cho Order o4
INSERT INTO DELIVERY_ASSIGNMENTS (ID, ORDER_ID, DRIVER_ID, PICKUP_ADDRESS, DROPOFF_ADDRESS, SCHEDULED_PICKUP, SCHEDULED_DELIVERY, DISTANCE_KM, DURATION_MINUTES, STATUS)
VALUES ('d3', 4, 6, 'Trà Sữa Gongcha - 45 Võ Văn Tần', 'Ký túc xá khu A, ĐHBK', '2024-12-28 15:15:00', '2024-12-28 15:35:00', 4.1, 20, 'completed');

-- 8. DELIVERY ROUTES (Khớp route trong assignments)
-- Route cho d1
INSERT INTO DELIVERY_ROUTES (ASSIGNMENT_ID, INSTRUCTION, DISTANCE_KM, DURATION_MINUTES, SEQUENCE_ORDER) VALUES
('d1', 'Rời Phở Hà Nội, rẽ phải vào đường Lý Thường Kiệt', 0.6, 3, 1),
('d1', 'Đi thẳng qua vòng xoay Nguyễn Tri Phương, tiếp tục hướng về Âu Cơ', 1.8, 8, 2),
('d1', 'Rẽ trái vào đường vào ký túc xá khu B', 1.0, 5, 3);

-- Route cho d2
INSERT INTO DELIVERY_ROUTES (ASSIGNMENT_ID, INSTRUCTION, DISTANCE_KM, DURATION_MINUTES, SEQUENCE_ORDER) VALUES
('d2', 'Chạy thẳng đường Nguyễn Thị Minh Khai 1,2km', 1.2, 6, 1),
('d2', 'Rẽ trái vào Trần Hưng Đạo, tiếp tục 900m', 0.9, 4, 2),
('d2', 'Đi vào cổng thư viện Tạ Quang Bửu', 0.5, 4, 3);

-- Route cho d3
INSERT INTO DELIVERY_ROUTES (ASSIGNMENT_ID, INSTRUCTION, DISTANCE_KM, DURATION_MINUTES, SEQUENCE_ORDER) VALUES
('d3', 'Rời Gongcha, đi thẳng Võ Văn Tần 1,5km', 1.5, 7, 1),
('d3', 'Rẽ phải vào Lê Duẩn, tiếp tục 2km', 2.0, 9, 2),
('d3', 'Rẽ vào cổng ký túc xá khu A', 0.6, 4, 3);